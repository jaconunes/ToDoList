unit uCadastrar;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ComCtrls,
  FireDAC.UI.Intf, FireDAC.VCLUI.Wait, FireDAC.Stan.Intf, FireDAC.Comp.UI,
  System.ImageList, Vcl.ImgList, Vcl.ToolWin, uTarefa,  Vcl.ExtCtrls, uConsultar, uITarefaService,
  uServiceFactory, uIFeriadoService, uExternalFactory;

type
  TfrmCadastrar = class(TForm)
    edTitulo: TEdit;
    dtData: TDateTimePicker;
    lbTitulo: TLabel;
    lbDescricao: TLabel;
    lbData: TLabel;
    lbStatus: TLabel;
    cbStatus: TComboBox;
    ToolBar1: TToolBar;
    btSalvar: TToolButton;
    ToolButton1: TToolButton;
    btPesquisar: TToolButton;
    ToolButton2: TToolButton;
    btExcluir: TToolButton;
    ToolButton3: TToolButton;
    btNovo: TToolButton;
    ImageList1: TImageList;
    memDescricao: TMemo;
    lbCod: TLabel;
    edCod: TEdit;
    pnPrincipal: TPanel;
    lbStatusDAO: TLabel;
    lbVencto: TLabel;
    dtVencto: TDateTimePicker;
    procedure btSalvarClick(Sender: TObject);
    procedure edCodExit(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure btExcluirClick(Sender: TObject);
    procedure btNovoClick(Sender: TObject);
    procedure btPesquisarClick(Sender: TObject);
    procedure FormKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure cbStatusExit(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormCreate(Sender: TObject);
  private
    { Private declarations }
    FTarefa        : TTarefa;
    FStatusDAO     : TStatusDAO;
    Form           : TForm;
    FTarefaService : ITarefaService;
    FFeriadoService: IFeriadoService;
    procedure CarregaDados;
    procedure Salvar;
    procedure LimpaCampos;
    procedure StatusDAO(prStatus : TStatusDAO);
  public
    { Public declarations }

    procedure CarregarTarefa(prTarefa : TTarefa);
  end;

var
  frmCadastrar: TfrmCadastrar;

implementation

{$R *.dfm}

{ TfrmCadastrar }

procedure TfrmCadastrar.btExcluirClick(Sender: TObject);
begin
  if (FStatusDAO = sdUpdate) and FTarefaService.Excluir(StrToIntDef(edCod.Text, 0)) then
    LimpaCampos;
end;

procedure TfrmCadastrar.btNovoClick(Sender: TObject);
begin
  edCod.Text := '';
  LimpaCampos;
  edCod.SetFocus;
end;

procedure TfrmCadastrar.btPesquisarClick(Sender: TObject);
begin
  Form := TfrmConsultar.Create(Self);
  Form.Show;
end;

procedure TfrmCadastrar.btSalvarClick(Sender: TObject);
begin
  Salvar;
end;

procedure TfrmCadastrar.CarregaDados;
begin
  if not Assigned(FTarefa) then
    FTarefa := TTarefa.Create;

  FTarefa := FTarefaService.TarefaPorId(StrToInt(edCod.Text));

  if Assigned(FTarefa) then
    begin
      LimpaCampos;

      edTitulo.Text      := FTarefa.Titulo;
      memDescricao.Lines.Add(FTarefa.Descricao);
      dtData.DateTime    := FTarefa.DataCriacao;
      cbStatus.ItemIndex := Ord(FTarefa.Status);

      StatusDAO(FTarefaService.GetStatusDAO);
    end
  else
    LimpaCampos;
end;

procedure TfrmCadastrar.CarregarTarefa(prTarefa: TTarefa);
begin
  FTarefa := prTarefa;

  if Assigned(FTarefa) then
    begin
      edTitulo.Text      := FTarefa.Titulo;
      memDescricao.Text  := FTarefa.Descricao;
      cbStatus.ItemIndex := Ord(FTarefa.Status);
    end;
end;

procedure TfrmCadastrar.cbStatusExit(Sender: TObject);
begin
  Salvar;
end;

procedure TfrmCadastrar.edCodExit(Sender: TObject);
begin
  if StrToIntDef(edCod.Text, 0) <> 0 then
    CarregaDados
  else
    LimpaCampos;
end;

procedure TfrmCadastrar.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  if (Owner <> nil) and (Owner is TfrmConsultar) then
    begin
      TfrmConsultar(Owner).Enabled := True;
      TfrmConsultar(Owner).cbStatusChange(TfrmConsultar(Owner).cbStatus);
    end;

  FTarefa.Free;
end;

procedure TfrmCadastrar.FormCreate(Sender: TObject);
begin
   FTarefa         := TTarefa.Create;
   FTarefaService  := TServiceFactory.CreateTarefaService;
   FFeriadoService := TExternalFactory.CreateFeriadoService;

end;

procedure TfrmCadastrar.FormKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if (Key = VK_RETURN) then
    self.Perform(WM_NEXTDLGCTL,0,0)
  else
  if (Key = VK_F3) then
    btPesquisar.Click
  else
  if (Key = VK_DELETE) then
    btExcluir.Click
  else
  if (Key = VK_F2) then
    btNovo.Click
  else
  if Key = VK_ESCAPE then
    Close;
end;

procedure TfrmCadastrar.FormShow(Sender: TObject);
begin
  StatusDAO(sdInsert);
  edCod.SetFocus;

  if (Owner <> nil) and (Owner is TfrmConsultar) then
    TfrmConsultar(Owner).Enabled := False;
end;

procedure TfrmCadastrar.LimpaCampos;
begin
  edTitulo.Text      := '';
  memDescricao.Lines.Clear;
  dtData.DateTime    := Now;
  cbStatus.ItemIndex := 0;
end;

procedure TfrmCadastrar.Salvar;
var
  wDesc : String;
begin
  if Trim(edTitulo.Text) = '' then
    begin
      ShowMessage('Informe o título da tarefa.');
      edTitulo.SetFocus;
      Exit;
    end;

  if not Assigned(FTarefa) then
    FTarefa := TTarefa.Create;

    FTarefa.Id             := StrToIntDef(edCod.Text, 0);
    FTarefa.Titulo         := edTitulo.Text;
    FTarefa.Descricao      := memDescricao.Text;
    FTarefa.Status         := TStatusTarefa(cbStatus.ItemIndex);
    FTarefa.DataVencimento := dtVencto.DateTime;

    if not FFeriadoService.EhFeriado(FTarefa.DataVencimento, wDesc) then
      FTarefaService.Salvar(FTarefa)
    else
      begin
        if MessageDlg(Format('A data de vencimento %s é um feriado: %s' + #13 + #13 +
                             'Deseja salvar mesmo assim?',
                             [DateToStr(FTarefa.DataVencimento), wDesc]), mtConfirmation, [mbYes, mbNo], 0) = mrYes then
          FTarefaService.Salvar(FTarefa)
      end;

    ModalResult := mrOk;
end;

procedure TfrmCadastrar.StatusDAO(prStatus: TStatusDAO);
begin
  FStatusDAO := prStatus;

  case FStatusDAO of
    sdInsert : lbStatusDAO.Caption := 'Inserindo...';
    sdUpdate : lbStatusDAO.Caption := 'Editando...';
  end;
end;

end.
