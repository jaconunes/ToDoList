unit uConsultar;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Data.DB, Vcl.Grids, Vcl.DBGrids, uTarefaService, uDMConexao, uTarefaDAO,
  Vcl.StdCtrls, System.ImageList, Vcl.ImgList, Vcl.ComCtrls, Vcl.ToolWin, uTarefa;

type
  TfrmConsultar = class(TForm)
    grTarefas: TDBGrid;
    dsTarefas: TDataSource;
    cbStatus: TComboBox;
    ImageList1: TImageList;
    ToolBar1: TToolBar;
    btRetroceder: TToolButton;
    ToolButton1: TToolButton;
    btAvancar: TToolButton;
    ToolButton2: TToolButton;
    btAtualizar: TToolButton;
    ToolButton3: TToolButton;
    btExcluir: TToolButton;
    btEditar: TToolButton;
    ToolButton5: TToolButton;
    procedure FormShow(Sender: TObject);
    procedure cbStatusChange(Sender: TObject);
    procedure grTarefasDrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure btRetrocederClick(Sender: TObject);
    procedure btAvancarClick(Sender: TObject);
    procedure btAtualizarClick(Sender: TObject);
    procedure StatusGetText(Sender: TField; var Text: string; DisplayText: Boolean);
    procedure StatusSetText(Sender: TField; const Text: string);
    procedure grTarefasCellClick(Column: TColumn);
    procedure FormKeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure btExcluirClick(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
  private
    { Private declarations }
    FDSTarefas : TDataSet;
    FTarefa    : TTarefa;
    procedure CarregaTarefas;
  public
    { Public declarations }
  end;

var
  frmConsultar: TfrmConsultar;

implementation

{$R *.dfm}

{ TfrmConsultar }

procedure TfrmConsultar.btAtualizarClick(Sender: TObject);
var
  wTarefa  : TTarefa;
  wService : TTarefaService;
begin
  if dsTarefas.DataSet.State = dsEdit then
    dsTarefas.DataSet.Post;

  if Assigned(FTarefa) then
    wTarefa := FTarefa
  else
    wTarefa := TTarefa.Create;

  wService := TTarefaService.Create(TTarefaDAO.Create(dmConexao.GetFDQuery));
  try
    wTarefa.Id          := dsTarefas.DataSet.FieldByName('id').AsInteger;
    wTarefa.Titulo      := dsTarefas.DataSet.FieldByName('titulo').AsString;
    wTarefa.Descricao   := dsTarefas.DataSet.FieldByName('descricao').AsString;
    wTarefa.Status      := TStatusTarefa(dsTarefas.DataSet.FieldByName('status').AsInteger);
    wTarefa.DataCriacao := dsTarefas.DataSet.FieldByName('data_criacao').AsDateTime;

    wService.StatusDAO := sdUpdate;
    wService.Salvar(wTarefa);
  finally
    wService.Free;
    wTarefa.Free;
    ShowMessage('Tarefa salva com sucesso!');
  end;
end;

procedure TfrmConsultar.btAvancarClick(Sender: TObject);
begin
  FDSTarefas.Next;
end;

procedure TfrmConsultar.btExcluirClick(Sender: TObject);
var
  wService : TTarefaService;
begin
  wService := TTarefaService.Create(TTarefaDAO.Create(dmConexao.GetFDQuery));
  try
    wService.Excluir(dsTarefas.DataSet.FieldByName('id').AsInteger);
    cbStatus.OnChange(cbStatus);
  finally
    wService.Free;
    ShowMessage('Tarefa excludída com sucesso!');
  end;
end;

procedure TfrmConsultar.btRetrocederClick(Sender: TObject);
begin
  FDSTarefas.Prior;
end;

procedure TfrmConsultar.CarregaTarefas;
var
   wService : TTarefaService;
begin
  wService := TTarefaService.Create(TTarefaDAO.Create(dmConexao.GetFDQuery));
  try
    if Assigned(FDSTarefas) then
       FDSTarefas.Free;

    FDSTarefas := wService.GetDSTarefas(cbStatus.ItemIndex - 1);
  finally
    wService.Free;
  end;

  dsTarefas.DataSet := FDSTarefas;
end;

procedure TfrmConsultar.cbStatusChange(Sender: TObject);
begin
  CarregaTarefas;
end;

procedure TfrmConsultar.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  if (Owner <> nil) and (Owner.ClassName = 'TfrmCadastrar') then
     TForm(Owner).Enabled := True;
end;

procedure TfrmConsultar.FormKeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
  if (Key = VK_RETURN) then
    btAtualizar.Click
  else
  if (Key = VK_DELETE) then
    btExcluir.Click;
end;

procedure TfrmConsultar.FormShow(Sender: TObject);
begin
  if (Owner <> nil) and (Owner.ClassName = 'TfrmCadastrar') then
     TForm(Owner).Enabled := False;

  CarregaTarefas;
  dsTarefas.DataSet.FieldByName('status').OnGetText := StatusGetText;
  dsTarefas.DataSet.FieldByName('status').OnSetText := StatusSetText;
end;

procedure TfrmConsultar.grTarefasCellClick(Column: TColumn);
var
  wI, wPos : Integer;
  wP       : TPoint;
begin
  if Column.FieldName = 'status' then
    begin
      if not (dsTarefas.DataSet.State in dsEditModes) then
        dsTarefas.DataSet.Edit;

      grTarefas.SelectedField := Column.Field;
      grTarefas.EditorMode := True;
    end;
end;

procedure TfrmConsultar.grTarefasDrawColumnCell(Sender: TObject;
  const Rect: TRect; DataCol: Integer; Column: TColumn;
  State: TGridDrawState);
var
  wTexto: string;
begin
  if Column.FieldName = 'status' then
    begin
      case Column.Field.AsInteger of
        0: grTarefas.Canvas.TextRect(Rect, Rect.Left + 2, Rect.Top + 2, 'Pendente');
        1: grTarefas.Canvas.TextRect(Rect, Rect.Left + 2, Rect.Top + 2, 'Em andamento');
        2: grTarefas.Canvas.TextRect(Rect, Rect.Left + 2, Rect.Top + 2, 'Concluída');
      end;

      grTarefas.DefaultDrawColumnCell(Rect, DataCol, Column, State);

      case Column.Field.AsInteger of
        0:
          begin
            grTarefas.Canvas.Font.Color := clRed;
            wTexto := 'Pendente';
          end;
        1:
          begin
            grTarefas.Canvas.Font.Color := $0000A5FF;
            wTexto := 'Em andamento';
          end;
        2:
          begin
            grTarefas.Canvas.Font.Color := clGreen;
            wTexto := 'Concluída';
          end;
      end;

      grTarefas.Canvas.FillRect(Rect);
      grTarefas.Canvas.TextRect(Rect, Rect.Left + 4, Rect.Top + 4, wTexto);
    end;
end;

procedure TfrmConsultar.StatusGetText(Sender: TField; var Text: string;
  DisplayText: Boolean);
begin
  case Sender.AsInteger of
    0: Text := 'Pendente';
    1: Text := 'Em andamento';
    2: Text := 'Concluída';
  else
    Text := '';
  end;
end;

procedure TfrmConsultar.StatusSetText(Sender: TField; const Text: string);
begin
  if SameText(Text, 'Pendente') then
    Sender.AsInteger := 0
  else if SameText(Text, 'Em andamento') then
    Sender.AsInteger := 1
  else if SameText(Text, 'Concluída') then
    Sender.AsInteger := 2;
end;

end.
