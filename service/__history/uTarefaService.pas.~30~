unit uTarefaService;

interface

uses
  System.SysUtils, Vcl.Dialogs, Vcl.Controls, uTarefa, uTarefaRepository, Data.DB, uITarefaService, uITarefaRepository;

type
  TTarefaService = class(TInterfacedObject, ITarefaService)
  private
    FDAO       : ITarefaRepository;
    FStatusDAO : TStatusDAO;
  public
    constructor Create(prDAO: ITarefaRepository);
    procedure Salvar(prTarefa: TTarefa);
    function Excluir(prId: Integer): Boolean;
    function TarefaPorId(prId: Integer) : TTarefa;
    function GetDSTarefas(prStatus: Integer = -1): TDataSet;
    function GetStatusDAO: TStatusDAO;
    procedure SetStatusDAO(prStatusDAO: TStatusDAO);
  end;

implementation

constructor TTarefaService.Create(prDAO: ITarefaRepository);
begin
  FDAO       := prDAO;
  FStatusDAO := sdInsert;
end;

procedure TTarefaService.Salvar(prTarefa: TTarefa);
begin
  if FStatusDAO = sdInsert then
    begin
      try
        FDAO.Inserir(prTarefa);
        ShowMessage('Tarefa salva com sucesso!');
      except on E: Exception do
        ShowMessage('Erro ao salvar tarefa: ' + E.Message);
      end;
    end
  else
    begin
      try
        FDAO.Atualizar(prTarefa);
        ShowMessage('Tarefa atualizada com sucesso!');
      except on E: Exception do
        ShowMessage('Erro ao atualizar tarefa: ' + E.Message);
      end;
    end;
end;

procedure TTarefaService.SetStatusDAO(prStatusDAO: TStatusDAO);
begin
  FStatusDAO := prStatusDAO;
end;

function TTarefaService.TarefaPorId(prId: Integer): TTarefa;
begin
  Result     := FDAO.TarefaPorId(prId);

  if Assigned(Result) then
     FStatusDAO := sdUpdate;
end;

function TTarefaService.Excluir(prId: Integer): Boolean;
begin
  Result := False;
  if (MessageDlg('Deseja mesmo excluir a tarefa?', mtWarning, [mbYes, mbNo], 0, mbNo) = mrYes) then
    begin
      try
        FDAO.Excluir(prId);
        ShowMessage('Tarefa excluída com sucesso!');
        Result := True;
      except on E: Exception do
        ShowMessage('Erro ao excluir tarefa: ' + E.Message);
      end;
    end;
end;

function TTarefaService.GetDSTarefas(prStatus: Integer): TDataSet;
begin
  Result := FDAO.GetDSTarefas(prStatus);
end;

function TTarefaService.GetStatusDAO: TStatusDAO;
begin
  Result := FStatusDAO
end;

end.
