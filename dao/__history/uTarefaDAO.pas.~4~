unit uTarefaDAO;

interface

uses
  System.Generics.Collections, FireDAC.Comp.Client, uTarefa;

type
  TTarefaDAO = class
  private
    FQuery: TFDQuery;
  public
    constructor Create(AQuery: TFDQuery);
    procedure Inserir(ATarefa: TTarefa);
    procedure Atualizar(ATarefa: TTarefa);
    procedure Excluir(AId: Integer);
    function Listar(prStatus: Integer = -1): TObjectList<TTarefa>;
  end;

implementation

constructor TTarefaDAO.Create(AQuery: TFDQuery);
begin
  FQuery := AQuery;
end;

procedure TTarefaDAO.Inserir(ATarefa: TTarefa);
begin
  FQuery.SQL.Text := 'INSERT INTO tarefas (titulo, descricao, status) ' +
                     'VALUES (:titulo, :descricao, :status)';

  FQuery.ParamByName('titulo').AsString    := ATarefa.Titulo;
  FQuery.ParamByName('descricao').AsString := ATarefa.Descricao;
  FQuery.ParamByName('status').AsInteger   := Ord(ATarefa.Status);
  FQuery.ExecSQL;
end;

procedure TTarefaDAO.Atualizar(ATarefa: TTarefa);
begin
  FQuery.SQL.Text := 'UPDATE tarefas SET titulo = :titulo, descricao = :descricao, status = :status ' +
                     'WHERE id=:id';

  FQuery.ParamByName('id').AsInteger := ATarefa.Id;
  FQuery.ParamByName('titulo').AsString := ATarefa.Titulo;
  FQuery.ParamByName('descricao').AsString := ATarefa.Descricao;
  FQuery.ParamByName('status').AsInteger := Ord(ATarefa.Status);
  FQuery.ExecSQL;
end;

procedure TTarefaDAO.Excluir(AId: Integer);
begin
  FQuery.SQL.Text := 'DELETE FROM tarefas WHERE id=:id';
  FQuery.ParamByName('id').AsInteger := AId;
  FQuery.ExecSQL;
end;

function TTarefaDAO.Listar(prStatus: Integer): TObjectList<TTarefa>;
var
  Tarefa: TTarefa;
begin
  Result := TObjectList<TTarefa>.Create(True);

  FQuery.SQL.Text := 'SELECT * FROM tarefas';
  if prStatus >= 0 then
    begin
      FQuery.SQL.Add('WHERE status = :status');
      FQuery.ParamByName('status').AsInteger := prStatus;
    end;

  FQuery.Open;
  while not FQuery.Eof do
    begin
      Tarefa             := TTarefa.Create;
      Tarefa.Id          := FQuery.FieldByName('id').AsInteger;
      Tarefa.Titulo      := FQuery.FieldByName('titulo').AsString;
      Tarefa.Descricao   := FQuery.FieldByName('descricao').AsString;
      Tarefa.Status      := TStatusTarefa(FQuery.FieldByName('status').AsInteger);
      Tarefa.DataCriacao := FQuery.FieldByName('data_criacao').AsDateTime;

      Result.Add(Tarefa);
      FQuery.Next;
    end;
end;

end.
